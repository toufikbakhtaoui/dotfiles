#!/usr/bin/env bash

# ────────────────────────────────────────────────────────────────────────────
# This script deletes :
#    - chezmoi's state file
#    - oh-my-zsh
#    - all configuration files
#    - brew packages
# ────────────────────────────────────────────────────────────────────────────

LOG_PATH="${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/log.sh"
source "$LOG_PATH"

set -euo pipefail

log info "🧹 Start rollback script !"

# ────────────────────────────────────────────────────────────────────────────
# Reset chezmoi state
# ────────────────────────────────────────────────────────────────────────────
chezmoi state reset
rm -rf ~/.local/state/chezmoi


# ────────────────────────────────────────────────────────────────────────────
# Delete .oh-my-zsh 
# ────────────────────────────────────────────────────────────────────────────
if [ -d "$HOME/.oh-my-zsh" ]; then
  log info "🗑 Removing ~/.oh-my-zsh"
  rm -rf "$HOME/.oh-my-zsh"
fi


# ────────────────────────────────────────────────────────────────────────────
# Delete all files generated by chezmoi 
# ────────────────────────────────────────────────────────────────────────────
log info "🧼 Cleaning up dotfiles..."
rm -f "$HOME/.zshrc"
rm -f "$HOME/.zsh_aliases"
rm -rf "$HOME/.config/nvim"
rm -rf "$HOME/.config/zsh"
rm -rf "$HOME/.gitconfig"
rm -rf "$HOME/.gitignoreglobal"


# ────────────────────────────────────────────────────────────────────────────
# Delete plugins 
# ────────────────────────────────────────────────────────────────────────────
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
rm -rf "${ZSH_CUSTOM}/plugins/zsh-autosuggestions"
rm -rf "${ZSH_CUSTOM}/plugins/zsh-syntax-highlighting"

# ────────────────────────────────────────────────────────────────────────────
# Delete homebrew packages
# ────────────────────────────────────────────────────────────────────────────
read -p "❓ This will completely uninstall all homebrew packages ? (y/N): " confirm
if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
  log info "🍺 Uninstalling all Homebrew packages..."
  if command -v brew &>/dev/null; then
  brew remove --force $(brew list) 2>/dev/null
  brew cleanup --prune=all -s && echo -e "Brew packages removed."
  fi
fi

log success "✅ Reset successfully done"

